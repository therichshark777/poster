<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        let messageData = [];

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ JSON
        function escapeSpecialChars(str) {
            return str
                .replace(/\\/g, "\\\\") // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω—ã–π —Å–ª—ç—à
                .replace(/\"/g, '\\\"')  // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                .replace(/\n/g, "\\n")    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                .replace(/\r/g, "\\r")    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤–æ–∑–≤—Ä–∞—Ç—ã –∫–∞—Ä–µ—Ç–∫–∏
                .replace(/\t/g, "\\t");   // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ç–∞–±—É–ª—è—Ü–∏–∏
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –∏–∑ —Ç–µ–∫—Å—Ç–∞
        function extractLinksFromText(text) {
            const urlRegex = /https?:\/\/[^\s]+/g;
            const matches = text.match(urlRegex);
            return matches || [];
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        async function handleNewMessage(messageElement) {
            const messageIdMatch = messageElement.id.match(/^message-(\d+)$/);
            const messageId = messageIdMatch ? parseInt(messageIdMatch[1], 10) : null;
            const unixTime = Math.floor(Date.now() / 1000); // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π Unix timestamp

            const newMessageData = {
                ...extractMessageData(messageElement),
                message_id: messageId,
                time: unixTime,
            };

            messageData.push(newMessageData);

            const url = 'https://poster-p2t2.onrender.com/process';
            //const url = 'http://localhost:3000/process';

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify([newMessageData]),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();

                // –ü–µ—á–∞—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–æ–Ω—Å–æ–ª—å
                console.log('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', result);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', error);
            }
        }

        function sendMessage(id)
        {
            const messageNode = document.querySelector('#message-' + id);
            console.log(extractMessageData(messageNode));
            handleNewMessage(messageNode);
        }
    </script>

    <script>
        function extractMessageData(messageElement) {
            const sender = messageElement.querySelector('.sender-title')?.textContent.trim() || '';
            const subheader = messageElement.querySelector('.embedded-text-wrapper span')?.textContent.trim() || '';

            const messageContentNode = messageElement.querySelector('.text-content');
            let messageContent = '';
            let links = [];

            if (messageContentNode) {
                // –ö–ª–æ–Ω–∏—Ä—É–µ–º —É–∑–µ–ª, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–æ–ø–∏–µ–π
                const clonedNode = messageContentNode.cloneNode(true);

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ –∏ –∑–∞–º–µ–Ω—è–µ–º –∏—Ö –Ω–∞ [link-{id}]
                let linkIndex = 1;
                clonedNode.querySelectorAll('a').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href) {
                        links.push(href.trim()); // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –≤ –º–∞—Å—Å–∏–≤
                        const placeholder = `[link-${linkIndex}]`;
                        link.replaceWith(document.createTextNode(placeholder)); // –ó–∞–º–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ [link-{id}]
                        linkIndex++;
                    }
                });

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–µ–∑ HTML
                messageContent = clonedNode.textContent.trim();
            }

            const senderId = messageElement.querySelector('.Avatar')?.dataset.peerId || '';

            return {
                sender: escapeSpecialChars(sender),
                subheader: escapeSpecialChars(subheader),
                messageContent: escapeSpecialChars(messageContent),
                links: links.map(escapeSpecialChars), // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏
                sender_id: escapeSpecialChars(senderId),
            };
        }

        // –ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function escapeSpecialChars(str) {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
    </script>
</head>
<body>
    <div id="message-111406" class="shown open Message message-list-item first-in-group allow-selection last-in-group was-edited" data-message-id="111406"><div class="bottom-marker" data-message-id="111406" data-should-update-views="false"></div><div class="message-select-control"></div><div class="Avatar size-small peer-color-9 interactive" data-peer-id="120643768" style=""><div class="inner"><img src="blob:https://web.telegram.org/b34fba33-6ab0-426b-bdb8-bcd6f74f6fbd" class="Avatar__media avatar-media opacity-transition slow open shown" alt="bad friend | moni" decoding="async" draggable="false"></div></div><div class="message-content-wrapper can-select-text"><div class="message-content peer-color-9 text has-shadow has-solid-background has-appendix has-footer" dir="auto" style=""><div class="content-inner" dir="auto"><div class="message-title" dir="ltr"><span class="message-title-name-container interactive" dir="ltr"><span class="forward-title-container"></span><span class="message-title-name"><span class="sender-title">bad friend | moni</span><div class="CEFe1FhH custom-emoji emoji" data-entity-type="MessageEntityCustomEmoji" data-document-id="5273726914681380081" data-alt="üëÅ"><img src="blob:https://web.telegram.org/71ebc27b-3f3a-4edf-8b73-a86b60bc7f3a" class="gYSfUe37 O_TaDxWg sticker-media opacity-transition slow shown open" alt="" draggable="false"></div></span></span><div class="title-spacer"></div><span class="admin-title" dir="auto">admin</span></div><div class="text-content clearfix with-meta" dir="auto">–ù—É –ª–æ–º–±–∞—Ä–¥ —Å –±–∞–±–∏–ª–æ–Ω–æ–º –≤–º–µ—Å—Ç–µ –∂–µ –∏–¥—É—Ç –≤ EtherFi<span class="MessageMeta" dir="ltr" data-ignore-on-paste="true"><span class="message-time" title="Dec 20, 2024, 13:38:24
        Edited: Dec 20, 2024, 13:38:40">edited 13:38</span></span></div></div><div class="message-action-buttons"></div><svg width="9" height="20" class="svg-appendix"><defs><filter x="-50%" y="-14.7%" width="200%" height="141.2%" filterUnits="objectBoundingBox" id="messageAppendix"><feOffset dy="1" in="SourceAlpha" result="shadowOffsetOuter1"></feOffset><feGaussianBlur stdDeviation="1" in="shadowOffsetOuter1" result="shadowBlurOuter1"></feGaussianBlur><feColorMatrix values="0 0 0 0 0.0621962482 0 0 0 0 0.138574144 0 0 0 0 0.185037364 0 0 0 0.15 0" in="shadowBlurOuter1"></feColorMatrix></filter></defs><g fill="none" fill-rule="evenodd"><path d="M3 17h6V0c-.193 2.84-.876 5.767-2.05 8.782-.904 2.325-2.446 4.485-4.625 6.48A1 1 0 003 17z" fill="#000" filter="url(#messageAppendix)"></path><path d="M3 17h6V0c-.193 2.84-.876 5.767-2.05 8.782-.904 2.325-2.446 4.485-4.625 6.48A1 1 0 003 17z" fill="FFF" class="corner"></path></g></svg><div class="quick-reaction"><img class="ReactionStaticEmoji opacity-transition slow open shown" src="blob:https://web.telegram.org/dc46210c-6580-4e38-9204-a4449d7d913c" alt="Red Heart" draggable="false" style="width: 28px; height: 28px;"></div></div></div></div>


    <button onclick="sendMessage(111406)">click</button>
</body>
</html>